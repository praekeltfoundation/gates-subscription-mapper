language: python
cache: pip
python:
  - "2.7"
  - "3.6"
addons:
    postgresql: "9.6"
services:
  - postgresql
install:
  - "pip install -e ."
  - "pip install -r requirements-dev.txt"
script:
  - flake8
  - py.test

matrix:
  include:
    # Create docker image on merge to develop
    - python: "2.7"
      sudo: required
      dist: trusty
      services: [docker]
      env:
        - IMAGE_NAME=praekeltfoundation/gates-subscription-mapper:develop
        - REGISTRY_USER=praekeltorgdeploy
        - secure: "TqDYJ/jMvQFOPB93uoG8VVZsdKeGdUaH8trs/GOBHiew6/Pk7qToDMLPKhJj3A6EQZWWDMbzdCnM/odQSgGeHHg+27ue3FXQ/2wnxaWiHjG5kfjv5QxFd9v0rCPYk7u8kWEiA0hC/t7gOpaT3U3OUR1UM2PQ9LqxWMLrH9864ypeCPtZnnj43CH6mGJZ5M2xmP1HwNKTI2dnLWbojhjtG4u0su3EmA2Uep/hwLg8hQv5Do/Wbjb2FnQGzg0pp9o1BcgoWSBYHLfYk2wfGe6RiyhbpQYiQxXkFlXdqc3tmTT8jJxAP4/nXRfDo9hIOJIgTz2QKMaW2hlXG3QDBIf8p+250WxrintJtlSpejD4CRcphxy9L8ynPIOgm3abNUnRjO+yNWVfxWE03Yo1lJs8l7y0A5jeV8m3cAkuRp5LZU2FonW6Mtadbi1ztiAR84rZazxkqKeL7puy0nQ1kZG0ohy6EWAsviDulTlWaBn0xiGQfp4CxPxoPdbv57Aslt/gt49nVRrdXe7FAerKkCtp1SLjKbcNBE7WT+dYiguIs/EjTXAUt2r4Cb89lt9Y+DwcrNnN58bgdJxhFP4xbmBlgGscSSNEYKqBhWk6U1cN3sudAn8ddHp/kCGy6Vo9y2nk5IS6jzSVhoVxIJB8fWTLIJf9/94LClMk5pLChUMRPAI="
      before_script:
        - docker pull "$IMAGE_NAME" || true
      script:
        - docker build --tag "$IMAGE_NAME" --cache-from "$IMAGE_NAME" .
      
      before_deploy:
        - pip install docker-ci-deploy==0.3.0
        - docker login -u "$REGISTRY_USER", -p "$REGISTRY_PASS"
      deploy:
        provider: script
        script: dcd --version "$(git rev-parse --short HEAD)" --version-latest "$IMAGE_NAME"
        on:
          branch: develop
      
      # Inherited build steps that we don't want
      install: []
      addons: {}

    # Create versioned docker image on new version tag
    - python: "2.7"
      sudo: required
      dist: trusty
      services: [docker]
      env:
        - IMAGE_NAME=praekeltfoundation/gates-subscription-mapper
        - REGISTRY_USER=praekeltorgdeploy
        - secure: "TqDYJ/jMvQFOPB93uoG8VVZsdKeGdUaH8trs/GOBHiew6/Pk7qToDMLPKhJj3A6EQZWWDMbzdCnM/odQSgGeHHg+27ue3FXQ/2wnxaWiHjG5kfjv5QxFd9v0rCPYk7u8kWEiA0hC/t7gOpaT3U3OUR1UM2PQ9LqxWMLrH9864ypeCPtZnnj43CH6mGJZ5M2xmP1HwNKTI2dnLWbojhjtG4u0su3EmA2Uep/hwLg8hQv5Do/Wbjb2FnQGzg0pp9o1BcgoWSBYHLfYk2wfGe6RiyhbpQYiQxXkFlXdqc3tmTT8jJxAP4/nXRfDo9hIOJIgTz2QKMaW2hlXG3QDBIf8p+250WxrintJtlSpejD4CRcphxy9L8ynPIOgm3abNUnRjO+yNWVfxWE03Yo1lJs8l7y0A5jeV8m3cAkuRp5LZU2FonW6Mtadbi1ztiAR84rZazxkqKeL7puy0nQ1kZG0ohy6EWAsviDulTlWaBn0xiGQfp4CxPxoPdbv57Aslt/gt49nVRrdXe7FAerKkCtp1SLjKbcNBE7WT+dYiguIs/EjTXAUt2r4Cb89lt9Y+DwcrNnN58bgdJxhFP4xbmBlgGscSSNEYKqBhWk6U1cN3sudAn8ddHp/kCGy6Vo9y2nk5IS6jzSVhoVxIJB8fWTLIJf9/94LClMk5pLChUMRPAI="
      before_script:
        - docker pull "$IMAGE_NAME" || true
      script:
        - docker build --tag "$IMAGE_NAME" --cache-from "$IMAGE_NAME" .
      
      before_deploy:
        - pip install docker-ci-deploy==0.3.0
        - docker login -u "$REGISTRY_USER", -p "$REGISTRY_PASS"
      deploy:
        provider: script
        script: dcd --version "$(git tag -l --points-at HEAD)" --version-semver --version-latest "$IMAGE_NAME"
        on:
          tags: true
      
      # Inherited build steps that we don't want
      install: []
      addons: {}
